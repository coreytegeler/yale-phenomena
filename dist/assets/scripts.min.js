$(function(){var e,t,a,n,r,i,s,o,l,d,p,u,c,f,m,v,h,g,y,b,C,w,x,j,q,k,O,I,L,T,z,_,E,P,N,S,J,R,M,F,U,D,Y,A,G,H,Z,B,W,X,K,Q;return"data/key8.csv",e=$("body"),s=$("#map"),n=$("#filters"),o=$("#phenomena"),t=$("#creation"),a=$("#embedder"),r=$("header.fixed"),i=$("header.fixed .sentence"),"pk.eyJ1IjoieWdkcCIsImEiOiJjamY5bXU1YzgyOHdtMnhwNDljdTkzZjluIn0.YS8NHwrTLvUlZmE8WEEJPg","mapbox://styles/ygdp/cjf9yeodd67sq2ro1uvh1ua67","prod",39.6,-99.4,3.4,0,24,1,5,window.query={map:{lat:39.6,lng:-99.4,zoom:3.4}},window.phen={},b=function(e){var t;return t="https://ygdp.yale.edu/phenomena/json",$.ajax({type:"GET",contentType:"application/json",dataType:"json",url:t,success:function(e,t,a){return E(e)},error:function(e){return console.log(e)}})},C=function(e){var t;return t="https://ygdp.yale.edu/phenomena/json/"+e,$.ajax({type:"GET",contentType:"application/json",dataType:"json",url:t,success:function(e,t,a){var n;return n=e[0],window.phen=n,Y()},error:function(e){return console.log(e)}})},Y=function(){return $("header .phenomenon").each(function(){return $(this).html(phen.title)})},E=function(e){var t,a,n,r,i;for(i=[],t=0,a=e.length;t<a;t++)r=e[t],(n=$("<option></option>")).text(r.title.replace(/(<([^>]+)>)/gi,"")),n.val(r.id),"156"===r.id&&n.attr("selected","selected"),i.push($('select[name="phenomenon"]').append(n));return i},j=function(){var e;return e="https://ygdp.yale.edu/sentences/json/"+query.map.phenomenon,$.ajax({type:"GET",contentType:"application/json",dataType:"json",url:e,success:function(e,t,a){return console.log(e),P(e)},error:function(e){return console.log(e)}})},P=function(e){var t,a,r,i,s,l;for(a=o.find("ul"),s=[],r=0,i=e.length;r<i;r++)l=e[r],t=$("<li></li>").addClass("sentence").attr("data-val",l.id).html("<span>"+l.title+"</span>"),a.append(t.addClass("option")),n.find(".fieldset.accept ul").append(t.clone()),s.push(n.find(".fieldset.reject ul").append(t.clone()));return s},N=function(e){var t;return e.preventDefault(),t=$("form").serializeArray(),{},$.each(t,function(){var e,t,a;return e=(a=this.name.split("."))[0],t=a[1],query.map[e]||(query.map[e]={}),t?query.map[e][t]=this.value:query.map[e]=parseFloat(this.value)}),G(),f()},f=function(){var t;return M(),j(),C(query.map.phenomenon),e.removeClass("form").addClass("map"),mapboxgl.accessToken="pk.eyJ1IjoieWdkcCIsImEiOiJjamY5bXU1YzgyOHdtMnhwNDljdTkzZjluIn0.YS8NHwrTLvUlZmE8WEEJPg",window.map=new mapboxgl.Map({container:"map",style:"mapbox://styles/ygdp/cjf9yeodd67sq2ro1uvh1ua67",zoom:query.map.zoom}),query.map.lng&&query.map.lat&&(t=new mapboxgl.LngLat(query.map.lng,query.map.lat),map.setCenter(t)),map.on("load",T)},T=function(){var e;return map.addLayer({id:"survey-data",type:"symbol",source:{type:"vector",url:"mapbox://"+phen.survey_id},"source-layer":phen.survey_name,layout:{"icon-allow-overlap":!0,"icon-size":{base:.9,stops:[[0,.2],[16,1.4]]},"icon-image":"marker"}}),e=map.getLayer("survey-data"),map.getBounds(e).toArray(),phen.coldspots_id&&phen.coldspots_name?map.addLayer({id:"coldspots",type:"fill",source:{type:"vector",url:"mapbox://"+phen.coldspots_id},"source-layer":phen.coldspots_name,minzoom:0,maxzoom:24,layout:{visibility:"none"},paint:{"fill-color":"rgba(141,171,247,0.3)"}}):$('.option[data-val="coldspots"]').addClass("disabled"),phen.hotspots_id&&phen.hotspots_name?map.addLayer({id:"hotspots",type:"fill",source:{type:"vector",url:"mapbox://"+phen.hotspots_id},"source-layer":phen.hotspots_name,minzoom:0,maxzoom:24,layout:{visibility:"none"},paint:{"fill-color":"rgba(228,139,139,0.3)"}}):$('.option[data-val="hotspots"]').addClass("disabled"),window.popup=new mapboxgl.Popup({closeButton:!1,closeOnClick:!1}),H(),v()},X=function(e){var t;if((t=$(this).parents("aside")).toggleClass("closed"),t.is("#phenomena"))return r.toggleClass("hide")},c=function(e){var t;return t=$(this).attr("data-val"),R(t),G()},R=function(e){var t,a,r,s,l;return(r=o.find('.option[data-val="'+e+'"]')).length||(e=(r=o.find(".option").first()).attr("data-val")),s=r.parents(".fieldset").parents("aside"),l=r.find("span").text(),s.find(".selected").removeClass("selected"),r.toggleClass("selected"),t=n.find(".fieldset.accepted"),a=n.find(".label.accepted"),t.attr("data-prop",e),a.attr("data-prop",e),s.attr("data-selected",e),r.is(".selected")?(i.text(l),Q(),t.removeClass("disabled")):(i.text(""),t.addClass("disabled"))},function(e){if(!e)return o.find(".sentence.selected")},u=function(e){var t,a,n,r;return a=$(this),!$(e.target).is(".inputs, .inputs *")&&((t=a.parents(".fieldset")).parents("aside"),n=t.attr("data-prop-slug")||t.attr("data-prop"),r=a.attr("data-val-slug")||a.attr("data-val"),S(n,r),G())},S=function(e,t){var a,n,r,i;if(t=O(e,t),["accept","reject"].includes(t)?(a=m(t),n=y(t,e)):(a=m(e),n=y(e,t)),a.addClass("open"),i=a.find(".selected"),r=a.find(".options"),n&&n.length)return n.is(".selected:not(.all)")?(n.removeClass("selected"),r.find(".selected").length||a.find(".all").addClass("selected")):n.addClass("selected"),n.is(".all")?i.filter(":not(.all)").removeClass("selected"):a.is(".radio")?i.removeClass("selected"):i.filter(".all").removeClass("selected"),a.is(".layers")?W(t):F()},U=function(e,t){var a,n;return n=(a=m(e)).find(".slider"),a.addClass("open"),2!==t.length&&(t=[1,100]),n.slider("values",t)},m=function(e){var t,a;return e=w(e),(t=n.find('.fieldset[data-prop="'+e+'"]')).length||(a=x(e),t=n.find('.fieldset[data-prop-slug="'+a+'"]')),t},y=function(e,t){var a,n,r;return a=m(e),t?(t=k(e,t),(n=a.find('.option[data-val="'+t+'"]')).length?n:(r=O(e,t),(n=a.find('.option[data-val-slug="'+r+'"]')).length?n:void 0)):a.find(".option.all")},B=function(e){var t,a,r;return a=$(this),n=a.parents("#filters"),a.is(".active")?(a.removeClass("active"),n.toggleClass("closed")):(n.removeClass("closed"),r=a.attr("data-form"),t=$('.form[data-form="'+r+'"]'),$(".tab.active").removeClass("active"),$(".form.active").removeClass("active"),a.addClass("active"),t.addClass("active"))},Z=function(e){return $(this).parents(".fieldset").toggleClass("open")},J=function(e){var t,a;if(!(t=$(this)).is(".selected"))return a=t.attr("data-prop-slug"),_(a)},_=function(e){var t,a,n,r,i;if((r=$('.multi-field[data-prop="'+e+'"]')).length)return(n=(a=r.parents(".fieldset")).find('.multi-label[data-prop-slug="'+e+'"]')).attr("data-prop"),a=n.parents(".fieldset"),i=n.attr("data-prop"),n.siblings().removeClass("selected"),n.addClass("selected"),(t=a.find('[data-prop="'+e+'"]')).siblings().removeClass("open").addClass("disabled"),t.addClass("open").removeClass("disabled"),a.attr("data-prop",i),a.attr("data-prop-slug",e),F(),G()},F=function(){var e,t,a,r,i,s,o,l,d,u,c,f,m,v,h,g,y;if(y={},n.find(".filter li.selected").each(function(e,t){var a,n,r;if(!$(t).parents(".disabled").length&&(r=$(t).parents(".filter").attr("data-prop"),n=$(t).attr("data-val")))return a=$(t).parents(".filter").attr("data-prop"),y[a]?y[a].push(n):y[a]=[n],p(r)}),o)o=p(prop);else for(o=["all"],"in",l=0,u=(g=Object.keys(y)).length;l<u;l++)if(r=g[l],i=y[r],r.indexOf("_")>-1&&i[0]&&"Age_Bin"!==r&&(i=i[0].split(",")),["accept","reject"].includes(r))for(d=0,c=i.length;d<c;d++){for(s=["in",t=i[d]],v=0,f=(a=q(r).split(",")).length;v<f;v++)e=a[v],s.push(parseInt(e));o.push(s)}else{for(s=["in",r],h=0,m=i.length;h<m;h++)t=i[h],Number.isInteger(parseInt(t))&&t.indexOf("-")<0&&(t=parseInt(t)),s.push(t);o.push(s)}if(n.find(".slider").each(function(e,t){var a,n,r,i;if(!(a=$(t)).parents(".disabled").length)if(a.find(".ui-slider-handle"),n=a.parents(".fieldset").attr("data-prop"),"","scale"===(r=a.attr("data-type"))){if(i=a.attr("data-val"))return o.push(["==",n,i]),"("+i+")"}else if("range"===r&&(y=a.slider("values")).length)return a.attr("data-val",y.join(",")),o.push([">=",n,y[0]]),o.push(["<=",n,y[1]])}),map.getLayer("survey-data"))return map.setFilter("survey-data",o)},p=function(e){var t,a,n,r,i;if(map.length&&(a=map.getFilter("survey-data"))){for((t=a.slice(0)).shift(),n=r=0,i=t.length;r<i;n=++r)t[n].indexOf(e)>-1&&a.splice(n+1);return a}},W=function(e){if(map.getLayer(e))return"visible"===map.getLayoutProperty(e,"visibility")?map.setLayoutProperty(e,"visibility","none"):map.setLayoutProperty(e,"visibility","visible")},A=function(){return $(".slider").each(function(e,t){var a,n,r,i,s,o,l;if(l=(n=$(t)).attr("data-type"),s=Number(n.attr("data-min")),r=Number(n.attr("data-max")),i=Number(((s+r)/2).toFixed(0)),o={min:s,max:r,range:"range"===l},"scale"===l?o.value=i:"range"===l&&(o.values=[s,r]),n.slider(o),"range"===l)return(a=n.find(".ui-slider-handle")).first().attr("data-val",s),a.last().attr("data-val",r)})},l=function(e,t){var a,n,r,i,s,o,l;return(n=$(this)).parents(".fieldset").attr("data-prop-slug"),"scale"===(s=n.attr("data-type"))?(o=t.value.toString(),n.attr("data-val",o)):"range"===s&&(i=(l=t.values)[0],r=l[1],n.attr("data-min",i),n.attr("data-max",r),(a=n.find(".ui-slider-handle")).first().attr("data-val",i),a.last().attr("data-val",r),o=[i,r].join(","),n.attr("data-val",o),n.attr("data-val-slug",o)),F(),G()},z=function(e){var t,a;return t=$(this).parents(".option"),(a=parseInt(this.value))?a<1?a=1:a>5&&(a=5):a=t.is(".accept")?5:1,$(this).val(a)},d=function(e){var t,a,n,r,i,s,o,l,d,p,u,c,f;return s=(r=$(this)).siblings("input"),n=(i=r.parents(".option")).siblings(".option.range-input"),f=parseInt(r.val()),c=i.attr("data-type"),u=s.val(),r.is(".min")&&f>u?s.val(f):r.is(".max")&&f<u&&s.val(f),f>5?f=5:f<1&&(f=1),r.val(f),a=n.find(".min"),t=n.find(".max"),l=parseInt(a.val()),o=parseInt(t.val()),"accept"===c&&f<=o?((d=f-1)<t.val()&&d++,d===o&&(d=f-1),d<1&&(d=1),t.val(d),d<l&&a.val(d)):"reject"===c&&f>=l&&((p=f+1)>a.val()&&p--,p===l&&(p=f+1),p>5&&(d=5),a.val(p),p>o&&t.val(p)),D(i),D(n),Q(),F(),G()},D=function(e){var t,a,n,r,i,s;for(n=[],t=a=i=e.find("input.min").val(),s=e.find("input.max").val();i<=s?a<=s:a>=s;t=i<=s?++a:--a)n.push(Math.abs(t));return r=JSON.stringify(n).replace(/[\[\]']+/g,""),e.attr("data-val",r)},q=function(e){var t;if("accept"===e)t=n.find(".option.accept");else{if("reject"!==e)return(t=n.find('.option[data-val="'+e+'"]')).length?t.attr("data-type"):null;t=n.find(".option.reject")}return t.attr("data-val")},L=function(e){return $(this).parents(".option").addClass("no-hover")},K=function(e){return $(this).parents(".option").removeClass("no-hover")},Q=function(){var e,t,a,n,r,i,s,o,l;if(i=$(".fieldset.phenomena .sentence.selected").attr("data-val")){for(t=$(".option.accept").attr("data-val"),e=JSON.parse("["+t+"]"),l=$(".option.reject").attr("data-val"),o=JSON.parse("["+l+"]"),s=[],a=n=1,5;n<=5;a=++n)e.indexOf(a)>-1?s.push([a,"marker-accepted"]):o.indexOf(a)>-1?s.push([a,"marker-rejected"]):s.push([a,""]);return r={property:i,type:"categorical",stops:s},map.setLayoutProperty("survey-data","icon-image",r)}},h=function(){var e,t,a,n,r,i,s,o,l,d,p;if(r={},s=window.location.search.substring(1)){for(t=a=0,n=(o=(s=decodeURIComponent(s)).split("&")).length;a<n;t=++a)e=(p=(i=o[t].split("="))[0].split("."))[1],d=p[2],l=i[1],"map"===p[0]&&(r[e]||(query.map[e]={}),d?query.map[e][d]=l:query.map[e]=parseFloat(l));return Object.keys(query.map).length}},G=function(){var e,t,a,n,r,i,l,d,p,u,c,f,m,v,h,g,y,b,C,w,j,q;for(f=window.query.map,e=o.find(".sentence.selected"),i=0,p=(y=Object.keys(window.query)).length;i<p;i++)l=y[i],["map","s"].indexOf(l)<0&&delete window.query[l];if(e.length&&(w=e.attr("data-val"),query.s=w),s.is(".mapboxgl-map")&&(a=map.getFilter("survey-data")))for(n=d=1,b=a.length-1;1<=b?d<=b:d>=b;n=1<=b?++d:--d)if((t=a[n])&&"all"!==t){for(m=x(t[1]),g=[],r=c=2,C=t.length-1;2<=C?c<=C:c>=C;r=2<=C?++c:--c)h=O(m,t[r]),g.push(h);q=g.join(),query[m]?query[m]=query[m]+","+q:query[m]=q}return window.query=Object.assign({map:f},query),v=(v=$.param(window.query)).replace(/\%5B/g,".").replace(/%5D/g,""),j=(u=window.location).origin+u.pathname,a&&(j=j.replace(u.search,"")),j+="?"+v,j=decodeURIComponent(j),history.pushState(g,"",j),M()},M=function(){var e;return e='<iframe width="100%" height="500px" src="'+window.location+'"></iframe>',a.find("textarea").html(e)},g=function(){return window.location.search.substring(1)&&h()?f():(e.addClass("form"),t.find("form").on("submit",N))},v=function(){var e,t,a,n,r,i,s,o,l,d,p,u;if(o=window.location.search.substring(1)){for(d=!1,e=t=0,n=(l=(o=decodeURIComponent(o)).split("&")).length;t<n;e=++t)if(s=(i=l[e].split("="))[0],u=i[1],"s"===s&&(d=!0,R(u)),_(s),"show"===s&&S(s,u),u=s.indexOf("_")<0?u.split(","):[q(u)],"age"===s)U(s,u);else if("s"!==s)for(a=0,r=u.length;a<r;a++)p=u[a],S(s,p);return d?void 0:R()}},I=function(e){var t,a,r,i,s,l,d,p,u,c,f,m,v,h;for(f=o.attr("data-selected"),map.getCanvas().style.cursor="pointer",h=(c=(d=e.features[0]).properties)[f],a=n.find(".option.accept").attr("data-val"),m=n.find(".option.reject").attr("data-val"),a.indexOf(h)>-1?r="#5fa990":m.indexOf(h)>-1&&(r="#795292"),c={Age:c.Age,Gender:c.Gender,Education:c.Education,Race:c.Race,"Place Raised":c.RaisedPlace,"Current Place":c.CurrentCity+", "+c.CurrentState,"Father Raised Place":c.DadCity+", "+c.DadState,"Mother Raised Place":c.MomCity+", "+c.MomState},v="<ul>",i=s=0,l=(u=Object.keys(c)).length;s<l;i=++s)v+="<li>"+(p=u[i])+": "+c[p]+"</li>",i>u.length-1&&(description+="</ul>");return popup.setLngLat(d.geometry.coordinates).setHTML(v).addTo(map),(t=$(popup._content)).parent().addClass("show").attr("data-id",d.id),t.css("background",r)},H=function(){return map.on("moveend",function(e){var t;return t=map.getCenter(),query.map.zoom=map.getZoom(),query.map.lng=t.lng,query.map.lat=t.lat,G()}),map.on("mouseenter","survey-data",I),map.on("mouseleave","survey-data",function(e){var t,a;return t=$(".mapboxgl-popup"),a=t.attr("data-id"),setTimeout(function(){var e;if(e=t.attr("data-id"),a===e)return t.removeClass("show")},500)})},w=function(e){var t,a;return(t=$('.fieldset[data-prop-slug="'+e+'"]'))&&(a=t.attr("data-prop"))?a:e},x=function(e){var t,a;return(t=$('.fieldset[data-prop="'+e+'"]'))&&(a=t.attr("data-prop-slug"))?a:e},k=function(e,t){var a,n,r;return e=w(e),(a=$('.fieldset[data-prop="'+e+'"]')).find(".slider").length?t:((n=a.find('.option[data-val-slug="'+t+'"]'))&&n.length||(n=a.find('.slider[data-val-slug="'+t+'"]')),n.length&&(r=n.attr("data-val")).length?r:t)},O=function(e,t){var a,n,r;return e=x(e),(a=$('.fieldset[data-prop-slug="'+e+'"]')).find(".slider").length?t:(n=a.find('.option[data-val="'+t+'"]')).length&&(r=n.attr("data-val-slug")||n.attr("data-val"))&&r.length?r:t},b(),g(),A(),new ClipboardJS(".instruct, #embed"),$("body").on("click","aside .label",Z),$("body").on("click","aside .multi-label",J),$("body").on("click","aside#filters .option",u),$(".slider").on("slidechange",l),$(".range-input input").on("keyup",z),$(".range-input input").on("change",d),$(".range-input .inputs").on("mouseenter",L),$(".range-input .inputs").on("mouseleave",K),$("body").on("click","aside .close",X),$("body").on("click","aside#phenomena ul li",c),$("body").on("click","aside#filters .tab",B)});